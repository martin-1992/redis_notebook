### AOF 持久化
　　由三个步骤组成，分别为命令追加（append）、文件写入、文件同步（sync）。

- 服务器执行完一个写命令后，会将该命令追加到  aof_buf 缓冲区的末尾；
- 每隔一段时间，调用 flushAppendOnlyFile 函数，批量写入到 AOF 文件中；
- 如果要保证同步，可使用 fsync 和 fdatasync 两个同步函数，强制写入磁盘，但会影响性能。生产环境，一般是每隔 1 秒执行一次 fsync 函数。

　　**先写入缓冲区，再批量写入磁盘，** 是常用操作。比如 CPU 从内存中读取值到 CPU 缓存中，CPU 修改完后不会立即写回内存，而是先写入缓存，过段时间再批量写入，这也是导致多线程数据不一致的原因。<br />
　　注意，只有对数据有修改的命令，比如读命令才会写入到 AOF 文件中，读命令不会。PUBSUB、SCRIPT LOAD 也会写入到 AOF 文件中。服务器只要重新执行一遍 AOF 文件里保存的命令，就可以还原到服务器关闭前的状态。

### AOF 重写
　　随着服务器运行，写入的命令越多，文件会越大，使用 AOF 文件载入的时间则会越长。重写 AOF 文件，可减少 AOF 文件大小。<br />
　　**AOF 重写不是分析原有的 AOF 文件，而是比对当前数据库和原有数据库，缺少的数据使用一条写命令来补齐。** 如果一条写命令的键值对超过 64，则分多条，防止缓冲区溢出。

#### AOF 重写流程

- Redis 主线程 fork 一个子线程执行 AOF 重写，使用当前的数据副本；
- 在子线程执行 AOF 重写，主线程会设置 AOF 重写缓冲区，将新的写命令追加到 AOF 缓冲区和 AOF 重写缓冲区；
- 当子线程完成 AOF 重写后，主线程会进行阻塞；
    1. 将 AOF 重写缓冲区的命令写入到新的 AOF 文件中；
    2. 新的 AOF 文件改名，覆盖掉旧的 AOF 文件；
- 完成替换后，取消阻塞，主线程继续执行客户端请求。