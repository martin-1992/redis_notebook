### 设置键的过期时间
　　使用 EXPIRE 命令或 PEXPIRE 命令，可按秒或毫秒设置某个键的生存时间（Time To Live，TTL），比如 EXPIRE abc 5，则键 abc 5 秒后过期。有 4 种命令设置键的生存时间（键能存在多久）或过期时间（键什么时候被删除）。

- EXPIRE &lt;key&gt; &lt;ttl&gt; 命令用于键 key 的生存时间设置为 ttl 毫秒；
- PEXPIRE &lt;key&gt; &lt;ttl&gt; 设置为 ttl 毫秒；
- EXPIREAT &lt;key&gt; &lt;timestamp&gt; 命令用于将键 key 的过期时间设置为 timestamp 所指定的秒数时间戳；
- PEXPIREAT &lt;key&gt; &lt;timestamp&gt; 指定毫秒时间戳。

　　EXPIRE、PEXPIRE、EXPIREAT 三个命令使用 PEXPIREAT 命令来实现，首先 EXPIRE 可转换成毫秒级的 PEXPIRE，在获取毫秒级的当前时间戳，加上 PEXPIRE，即为 PEXPIREAT。

### 过期字典
　　redisDb 结构的 expires 字典保存了数据库中所有键的过期时间，为过期字典。

- 过期字典的键是一个指针，指向键空间中的某个键对象（数据库键）。即键空间和过期字典的键都指向同一个键对象，节省内存；
- 过期字典的值是一个 long 类型的整数，保存了键所指向的数据库键的过期时间，毫秒精度的 UNIX 时间戳。

### 过期键删除策略

- **定时删除（主动删除），对内存友好，但对 CPU 不友好。** 在 CPU 使用高峰时，执行定时删除，会影响其性能。同时，创建定时器用到 Redis 服务器的时间事件，它是使用无序链表，导致查找一个事件的时间复杂度为 O(N)；
- **惰性删除（被动删除），对 CPU 时间最友好，但对内存最不友好。** 获取键时，检查是否过期，过期则删除。如果有很多键没有访问获取（数据太旧），则没法删除，相当于内存泄漏；
- **定期删除（主动删除），前两种的折中。** 设定删除操作执行的时长，每隔一段时间，检查一次并删除。

### Redis 的过期策略
　　定期删除 + 惰性删除。

- 定期删除，规定时间内，分多次遍历服务器中的各个数据库，从数据库的过期字典中随机删除部分；
    1. 每秒进行十次过期扫描，使用贪心策略，从过期字典中随机抽取 20 个 key，并删除；
    2. 如果过期的 key 占比超过 1/4，就重复前面流程。为防止一直扫描，默认扫描时间不超过 25ms。
- 惰性删除，获取时检查是否过期，过期则删除，不返回任何东西。

　　注意，如果大批 key 在同一时间过期，会导致 Redis 多次扫描过期字典，直到比重降低到 1/4 以下。这样会影响到 Redis 的性能，为避免这种情况，**建议将过期时间随机化，防止同一时间过期。**
 
### 从库的过期策略
　　从库不会进行过期扫描，当主库的 key 到期时，会在 AOF 文件增加一条 del 指令，同步到所有从库。然后从库通过执行这条 del 指令来删除过期的
key。<br />
　　这种方法是异步的，所以会出现主从延迟的情况，即主库已经删除，但从库的数据还存在。
